<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wsc.common.user.BatchWorkRevise">

    <!-- ========================================================== -->
    <!--   Oracle Paging Clause                                     -->
    <!-- ========================================================== -->
    <sql id="pagingColumns">
        <if test="start == null or end == null">
            ,0 AS RNUM
        </if>
    </sql>
    <sql id="pagingOpen">
        <if test="start != null and end != null">
            SELECT * 
              FROM (
                    SELECT X.*
                      FROM (
                            SELECT Z1.*, @rownum := @rownum+1 as RNUM
                              FROM (
        </if>
    </sql>
    <sql id="pagingClose">
        <if test="start != null and end != null">
                                   ) Z1, (SELECT @rownum:=0 ) Z2
                           ) X
                     WHERE RNUM <![CDATA[< ]]> #{end}
                   ) X
             WHERE RNUM <![CDATA[>= ]]> #{start}
        </if>  
    </sql>
    
    <!-- 정렬 -->
    <sql id="sortClause">
	  	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(gsSorts)">
		  	<foreach item="sort" collection="gsSorts" open="" separator="," close="">
		        ${sort}
		  	</foreach>
	  	</if>
	  	<if test="@com.wsc.framework.utils.MybatisUtils@empty(gsSorts)">
         	   JOB_ID, JOB_TYPE DESC
	  	</if>
    </sql>

	<!-- 조회 컬럼 -->
    <sql id="selectColumns">
           JOB_ID           AS "jobId"
        ,JOB_GRUP		    AS "jobGrup"
        ,JOB_TYPE           AS "jobType"
        ,JOB_TERM           AS "jobTerm"
        ,JOB_TIME           AS "jobTime"
        ,JOB_CMD			AS "jobCmd"
        ,JOB_DESC			AS "jobDesc"
        ,ERR_PROC			AS "errProc"
        ,JOB_MNG			AS "jobMng"
        ,USE_FLAG			AS "useFlag"
        ,JOB_REMK			AS "jobRemk"
        ,REGI_ID			AS "regiId"
        ,REGI_DATE 			AS "regiDate"
        ,CHNG_ID 			AS "chngId"
        ,CHNG_DATE 			AS "chngDate"
    </sql>
    
    <!-- 수정(db 업데이트문 사용) -->
    <sql id="updateColumns"> 
           CHNG_ID   = #{gsUserId}
         , CHNG_DATE = NOW()
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(jobId)">, JOB_ID = #{jobId}  </if>
        , JOB_GRUP = #{jobGrup}
        ,JOB_TYPE = #{jobType}
        ,JOB_TERM = #{jobTerm} 
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(jobTime )"> ,JOB_TIME = #{jobTime}   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(jobCmd)"> ,JOB_CMD = #{jobCmd}  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(jobDesc)"> ,JOB_DESC = #{jobDesc}  </if>
        ,ERR_PROC = #{errProc}
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(jobMng)"> ,JOB_MNG	= #{jobMng}  </if>
        ,USE_FLAG = #{useFlag}
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(jobRemk)"> ,JOB_REMK = #{jobRemk}  </if>        
    </sql>
    
    <!--쿼리 조건문-->
    <sql id="whereClause"> 
    	SYS_ID = #{sysId}
    	
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(jobId)">AND JOB_ID      = #{jobId}      </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(jobGrup)">AND JOB_GRUP  = #{jobGrup}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(jobTerm)">AND JOB_TERM  = #{jobTerm}    </if>
        
    </sql>
    
    <!--검색-->
    <select id="search" resultType="record" parameterType="params">
        <include refid="pagingOpen"  /><!-- PAGING -->
        SELECT <include refid="selectColumns" />
               <include refid="pagingColumns" /><!-- PAGING -->
          FROM SYS_JOB_MAST                                                                                                                                                   
         WHERE <include refid="whereClause"/>
         
         ORDER 
            BY <include refid="sortClause" /><!-- SORT -->
        <include refid="pagingClose" /><!-- PAGING -->
    </select>
    
    <!-- 컬럼 데이터 수 조회-->
    <select id="searchCount" resultType="int" parameterType="params">
        SELECT COUNT(1) <!-- count(1):전체검색 -->
          FROM SYS_JOB_MAST
		 WHERE <include refid="whereClause" />
    </select>
    
    <!-- 팝업창 작업id 자동생성 -->
    <insert id="BatchWorkReviseinsertJob" parameterType="params">
    
    <selectKey resultType="string" keyProperty="jobId" order="BEFORE">
            SELECT CONCAT('SYS-JOB-', LPAD(CAST(ifnull(SUBSTR(MAX(JOB_ID),9,4),'0') AS UNSIGNED)+1, 4, '0') )
                AS "jobId"
              FROM SYS_JOB_MAST
              WHERE SYS_ID = #{sysId} 
    </selectKey>
    
        INSERT 
          INTO SYS_JOB_MAST 
             ( SYS_ID
             , JOB_ID
             , JOB_GRUP
             , JOB_TYPE
             , JOB_TERM
             , JOB_TIME
             , JOB_CMD
             , JOB_DESC
             , ERR_PROC
             , JOB_MNG
             , USE_FLAG
             , JOB_REMK
             , REGI_ID
             , REGI_DATE
             , CHNG_ID
             , CHNG_DATE
         
             )
        VALUES
             ( #{sysId}
             , #{jobId}
             , #{jobGrup}
             , #{jobType}
             , #{jobTerm}
             , #{jobTime}
             , #{jobCmd}
             , #{jobDesc}
             , #{errProc}
             , #{jobMng}
             , #{useFlag}
             , #{jobRemk}
             , #{gsUserId}
             , NOW()
             , #{gsUserId}
             , NOW()    
             )
    </insert>
    
    <update id="BatchWorkReviseupdateJob" parameterType="params">
        UPDATE SYS_JOB_MAST
           SET <include refid="updateColumns" />
         WHERE SYS_ID = #{sysId}
           AND JOB_ID = #{jobId}
    </update>

</mapper>
