<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wsc.common.user.UserLogList">

    <!-- ========================================================== -->
    <!--   Oracle Paging Clause                                     -->
    <!-- ========================================================== -->
    <sql id="pagingColumns">
        <if test="start == null or end == null">
            ,0 AS RNUM
        </if>
    </sql>
    <sql id="pagingOpen">
        <if test="start != null and end != null">
            SELECT * 
              FROM (
                    SELECT X.*
                      FROM (
                            SELECT Z1.*, @rownum := @rownum+1 as RNUM
                              FROM (
        </if>
    </sql>
    <sql id="pagingClose">
        <if test="start != null and end != null">
                                   ) Z1, (SELECT @rownum:=0 ) Z2
                           ) X
                     WHERE RNUM <![CDATA[< ]]> #{end}
                   ) X
             WHERE RNUM <![CDATA[>= ]]> #{start}
        </if>  
    </sql>
    <sql id="sortClause">
	  	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(gsSorts)">
		  	<foreach item="sort" collection="gsSorts" open="" separator="," close="">
		        ${sort}
		  	</foreach>
	  	</if>
	  	<if test="@com.wsc.framework.utils.MybatisUtils@empty(gsSorts)">
         	   A.ACC_TIME DESC
	  	</if>
    </sql>

    <sql id="selectColumns">
    A.SYS_ID           AS "sysId",
    A.ACC_TIME         AS "accTime",
    A.USER_ID          AS "userId",
    A.PROG_ID          AS "progId",
    A.LOGIN_DATE       AS "loginDate",
    A.CLIENT_IP        AS "clientIp",
    A.CLIENT_NAME      AS "clientName",
    A.CLIENT_AGENT     AS "clientAgent",
    B.USER_TYPE        AS "userType",
    IFNULL(A.LOG_REMK,'') AS "logRemk"
    </sql>
    
    <sql id="whereClause">
    	A.SYS_ID = #{sysId}
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(userId     )">AND A.USER_ID LIKE concat('%',#{userId},'%')  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(loginDate  )">AND A.LOGIN_DATE   = #{loginDate}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(clientIp   )">AND A.CLIENT_IP    = #{clientIp}     </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(clientName )">AND A.CLIENT_NAME  = #{clientName}   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(clientAgent)">AND A.CLIENT_AGENT = #{clientAgent}  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(progId)">AND A.PROG_ID LIKE concat(#{progId},'%')  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(userType)">AND (
                CASE
                    WHEN #{userType} = 'LSTA' THEN (B.USER_TYPE = 'A')
                    WHEN #{userType} = 'DEALER' THEN (B.USER_TYPE = 'C')
                    ELSE ''
                END
            )  </if>
        <choose>
        	<when test="@com.wsc.framework.utils.MybatisUtils@notEmpty(accTimeBgn) or @com.wsc.framework.utils.MybatisUtils@notEmpty(accTimeEnd)">
        		AND DATE_FORMAT(ACC_TIME,'%Y-%m-%d') BETWEEN FN_CONV_DATE(#{accTimeBgn}) AND FN_CONV_DATE(#{accTimeEnd})
        	</when>
        	<otherwise>
        		AND DATE_FORMAT(ACC_TIME,'%Y-%m-%d') BETWEEN DATE_FORMAT(NOW(),'%Y-%m-%d') AND DATE_FORMAT(NOW(),'%Y-%m-%d')
        	</otherwise>
        </choose>
    </sql>
    
    <select id="search" resultType="record" parameterType="params">
        <include refid="pagingOpen"  /><!-- PAGING -->
        SELECT <include refid="selectColumns" />
               <include refid="pagingColumns" /><!-- PAGING -->
          FROM SYS_ULOG A
          INNER JOIN sys_user B ON A.SYS_ID = B.SYS_ID AND A.USER_ID = B.USER_ID
         WHERE <include refid="whereClause" />
         ORDER 
            BY <include refid="sortClause" /><!-- SORT -->
        <include refid="pagingClose" /><!-- PAGING -->
    </select>
    <select id="searchCount" resultType="int" parameterType="params">
        SELECT COUNT(1) 
          FROM SYS_ULOG A
           INNER JOIN sys_user B ON A.SYS_ID = B.SYS_ID AND A.USER_ID = B.USER_ID
         WHERE <include refid="whereClause" />
    </select>
    <insert id="insert" parameterType="params">
        CALL sp_insert_sys_ulog(#{sysId}, #{userId}, #{progId}, DATE_FORMAT(NOW(),'%Y%m%d'), #{clientIp}, #{clientName}, #{clientAgent}, #{logRemk})
        <!--  
        INSERT 
          INTO SYS_ULOG 
             ( SYS_ID
             , PROG_ID
             , USER_ID
             , ACC_TIME
             , LOGIN_DATE
            <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(clientIp   )">, CLIENT_IP    </if>
            <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(clientName )">, CLIENT_NAME  </if>
            <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(clientAgent)">, CLIENT_AGENT </if>
             )
        VALUES
             ( #{sysId}
             , #{progId}
             , #{userId}
             , DATE_FORMAT(NOW(),'%Y-%m-%d %H:%i:%s')
             , DATE_FORMAT(NOW(),'%Y%m%d') 
            <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(clientIp   )">, #{clientIp}     </if>
            <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(clientName )">, #{clientName}   </if>
            <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(clientAgent)">, #{clientAgent}  </if>
             )
        -->
    </insert>
    <delete id="delete" parameterType="params">
        DELETE 
          FROM SYS_ULOG
         WHERE SYS_ID    = #{sysId}
           AND USER_ID   = #{userId}
           AND PROG_ID   = #{progId}
           <!-- AND ACC_TIME  = #{accTime} -->
    </delete>
    
    <select id="getUserType1" resultType="record" parameterType="params">
    	SELECT CODE_NAME AS CODE_NAME
		FROM SYS_CODE
		WHERE SYS_ID = #{sysId}
	    AND   CODE_GRUP = 'USER_TYPE'
	    AND   CODE_CD IN ('A','C')
   </select>

</mapper>
