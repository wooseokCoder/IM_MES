<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wsc.common.board.BoardManagement">

    <!-- ========================================================== -->
    <!--   Oracle Paging Clause                                     -->
    <!-- ========================================================== -->
    <sql id="pagingColumns">
        <if test="start == null or end == null">
            ,0 AS "rnum"
        </if>
    </sql>
    <sql id="pagingOpen">
        <if test="start != null and end != null">
            SELECT * 
              FROM (
                    SELECT X.*
                      FROM (
                            SELECT Z1.*, @rownum := @rownum+1 as RNUM
                              FROM (
        </if>
    </sql>
    <sql id="pagingClose">
        <if test="start != null and end != null">
                                   ) Z1, (SELECT @rownum:=0 ) Z2
                           ) X
                     WHERE RNUM <![CDATA[< ]]> #{end}
                   ) X
             WHERE RNUM <![CDATA[>= ]]> #{start}
        </if>  
    </sql>
    <sql id="sortClause">
	  	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(gsSorts)">
		  	<foreach item="sort" collection="gsSorts" open="" separator="," close="">
		        ${sort}
		  	</foreach>
	  	</if>
	  	<if test="@com.wsc.framework.utils.MybatisUtils@empty(gsSorts)">
			A.REGI_DATE DESC, A.BORD_SEQ ASC
	  	</if>
    </sql>
    
    <sql id="selectColumns">
       A.SYS_ID AS "sysId"
     , A.BORD_GRUP AS "bordGrup"
     , fn_get_code_name('BORD_GRUP',A.BORD_GRUP, #{gsLang}) AS "codeName"
     , A.BORD_NO AS "bordNo"
     , A.BORD_TITLE AS "bordTitle" 
     , A.BORD_TYPE AS "bordType"
     , A.BORD_BGN AS "bordBgn"
     , A.BORD_END AS "bordEnd"
     , A.READ_CNT AS "readCnt"
     , A.BORD_SEQ AS "bordSeq"
     , A.USE_FLAG AS "useFlag"
     , A.REGI_ID AS "regiId"
     , DATE_FORMAT(A.REGI_DATE,'%Y-%m-%d %H:%i:%s')  AS "regiDate"
     , A.CHNG_ID AS "chngId"
     , DATE_FORMAT(A.CHNG_DATE,'%Y-%m-%d %H:%i:%s')  AS "chngDate"
     , A.BORD_PNO AS "bordPno"
     , A.OPEN_TYPE AS "openType"
    </sql>
    <sql id="insertColumns-fields">
           SYS_ID
         , BORD_NO
         , BORD_GRUP
         , BORD_TITLE
         , READ_CNT
         , BORD_SEQ
         , USE_FLAG
         , REGI_ID
         , REGI_DATE
         , CHNG_ID
         , CHNG_DATE
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordType )">, BORD_TYPE  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordBgn  )">, BORD_BGN   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordEnd  )">, BORD_END   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordPno  )">, BORD_PNO   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(openType )">, OPEN_TYPE  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordText )">, BORD_TEXT  </if>
    </sql>
    <sql id="insertColumns-values">
           #{sysId}
         , #{bordNo}
         , #{bordGrup}
         , #{bordTitle}
         , 0
         , 999999999
         , 'Y'
         , #{gsUserId}
         , NOW()
         , #{gsUserId}
         , NOW()
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordType )">, #{bordType}  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordBgn  )">, #{bordBgn}   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordEnd  )">, #{bordEnd}   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordPno  )">, #{bordPno}   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(openType )">, #{openType}  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordText )">, #{bordText:BLOB}  </if>
    </sql>
    <sql id="updateColumns">
    	BORD_SEQ = #{bordSeq}
    </sql>
    <sql id="whereClause">
    		SYS_ID    = #{sysId}
        AND A.USE_FLAG = 'Y'
        AND A.BORD_TYPE = 'ALL'
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(codeGrup  )">AND BORD_GRUP   = ( CASE WHEN #{codeGrup} = 'ALL' THEN BORD_GRUP ELSE #{codeGrup} END )</if>
    	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(useFlag  )">AND USE_FLAG   = #{useFlag}    </if>
    	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(regiId   )">AND REGI_ID    = #{regiId}     </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordTitle)">AND BORD_TITLE LIKE CONCAT('%',#{bordTitle},'%')</if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordText )">AND BORD_TEXT  LIKE CONCAT('%',#{bordText},'%')</if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordType )">AND BORD_TYPE  = #{bordType}   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordBgn  )">AND BORD_BGN   = #{bordBgn}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordEnd  )">AND BORD_END   = #{bordEnd}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(openType )">AND OPEN_TYPE  = #{openType}   </if>
	    <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(searchText) and @com.wsc.framework.utils.MybatisUtils@notEmpty(searchKey)">
			<choose>
	    		<when test="searchKey == 'S01'"> 
	    			AND A.BORD_TITLE LIKE CONCAT('%',#{searchText},'%')
	    		</when>
	    		<when test="searchKey == 'S02'"> 
	    			AND A.BORD_TEXT  LIKE CONCAT('%',#{searchText},'%')
	    		</when>
	    		<when test="searchKey == 'S03'"> 
	    			AND EXISTS (
	    			    SELECT 1
	    			      FROM SYS_USER
	    			     WHERE SYS_ID  = A.SYS_ID
	    			       AND USER_ID = A.REGI_ID
	    			       AND USER_NAME LIKE CONCAT('%',#{searchText},'%')
	    			    )
	    		</when>
	    		<otherwise>
	    		</otherwise>
			</choose>
	    </if>
    </sql>

    <select id="search" resultType="record" parameterType="params">
        <include refid="pagingOpen"  /><!-- PAGING -->
        SELECT <include refid="selectColumns" />
               <include refid="pagingColumns" /><!-- PAGING -->
          FROM SYS_BORD A
         WHERE <include refid="whereClause" />
         ORDER 
            BY <include refid="sortClause" /><!-- SORT -->
        <include refid="pagingClose" /><!-- PAGING -->
    </select>
    <select id="searchCount" resultType="int" parameterType="params">
        SELECT COUNT(1) 
          FROM SYS_BORD A
         WHERE <include refid="whereClause" />
    </select>
    <select id="select" resultType="record" parameterType="params">
        SELECT <include refid="selectColumns" />
              ,BORD_TEXT  AS "bordText"
          FROM SYS_BORD A
         WHERE SYS_ID    = #{sysId}
           AND BORD_NO   = #{bordNo}
           AND BORD_GRUP = #{bordGrup}
           AND BORD_SEQ = #{boardSeq}
    </select>
    <insert id="insert" parameterType="params">
    </insert>
    <update id="update" parameterType="params">
        UPDATE SYS_BORD
           SET <include refid="updateColumns" />
         WHERE SYS_ID    = #{sysId}
           AND BORD_NO   = #{bordNo}
           AND BORD_GRUP = #{bordGrup}
    </update>
    <delete id="delete" parameterType="params">
        DELETE 
          FROM SYS_BORD
         WHERE SYS_ID    = #{sysId}
           AND BORD_NO   = #{bordNo}
           AND BORD_GRUP = #{bordGrup}
    </delete>
	<select id="getBordTypeCode" resultType="record" parameterType="params">
		SELECT CODE_CD AS "codeCd"
		     , CODE_NAME AS "codeName"
		  FROM SYS_CODE
		 WHERE SYS_ID=#{sysId}
		   AND CODE_GRUP = 'BORD_GRUP'
		   AND USE_FLAG = 'Y'
		 ORDER BY SORT_SEQ ASC
	</select>

</mapper>
