<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wsc.common.exhbn.Exhibition">

    <!-- ========================================================== -->
    <!--   Oracle Paging Clause                                     -->
    <!-- ========================================================== -->
    <sql id="pagingColumns">
        <if test="start == null or end == null">
            ,0 AS "rnum"
        </if>
    </sql>
    <sql id="pagingOpen">
        <if test="start != null and end != null">
            SELECT *
              FROM (
                    SELECT X.*
                      FROM (
                            SELECT Z1.*, @rownum := @rownum+1 as RNUM
                              FROM (
        </if>
    </sql>
    <sql id="pagingClose">
        <if test="start != null and end != null">
                                   ) Z1, (SELECT @rownum:=0 ) Z2
                           ) X
                     WHERE RNUM <![CDATA[< ]]> #{end}
                   ) X
             WHERE RNUM <![CDATA[>= ]]> #{start}
        </if>
    </sql>

    <sql id="sortClause">
	  	SEQ
    </sql>
    
    <sql id="selectColumns">
          SYS_ID            AS "sysId"
        , SEQ               AS "seq"
        , EXHBN_CODE        AS "exhbnCode"
        , EXHBN_YEAR        AS "exhbnYear"
        , EXHBN_NAME        AS "exhbnName"
        , DATE_FORMAT(EXHBN_BGN_DATE,'%m.%d.%Y')    
                            AS "exhbnBgnDate"
        , DATE_FORMAT(EXHBN_END_DATE,'%m.%d.%Y')    
                            AS "exhbnEndDate"
        , EXHBN_LOC         AS "exhbnLoc"
        , MAX_NUM           AS "maxNum"
        , COUPON_YN			AS "useFlag"		
        , ACTIVE_YN         AS "activeYn"
        , FILE_NAME         AS "fileName"
        , USE_YN            AS "useYn"
        , REGI_ID           AS "regiId"
        , DATE_FORMAT(REGI_DATE,'%Y-%m-%d %H:%i:%s')
                            AS "regiDate"
        , CHNG_ID           AS "chngId"
        , DATE_FORMAT(CHNG_DATE,'%Y-%m-%d %H:%i:%s')
                            AS "chngDate"
    </sql>

    <sql id="insertColumns-fields">
           SYS_ID
         , SEQ
         , EXHBN_CODE
         <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnYear)"   >, EXHBN_YEAR     </if>
         <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnName)"   >, EXHBN_NAME     </if>
         <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnBgnDate)">, EXHBN_BGN_DATE </if>
         <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnEndDate)">, EXHBN_END_DATE </if>
         <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnLoc)"    >, EXHBN_LOC      </if>
         <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(maxNum)"      >, MAX_NUM        </if>
         <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(useFlag)"    >, COUPON_YN      </if>
         <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(activeYn)"    >, ACTIVE_YN      </if>
         , USE_YN
         , REGI_ID
         , REGI_DATE
         , CHNG_ID
         , CHNG_DATE
    </sql>

    <sql id="insertColumns-values">
           #{sysId}
         , (SELECT A.seq
            FROM  (SELECT MAX(SEQ)+1 AS 'seq'
                   FROM   EXHBN_MAST) A)
         , #{exhbnCode}
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnYear)"   >, #{exhbnYear}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnName)"   >, #{exhbnName}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnBgnDate)">, DATE_FORMAT(STR_TO_DATE(#{exhbnBgnDate}, '%m.%d.%Y'),'%Y-%m-%d') </if> 
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnEndDate)">, DATE_FORMAT(STR_TO_DATE(#{exhbnEndDate}, '%m.%d.%Y'),'%Y-%m-%d') </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnLoc)"    >, #{exhbnLoc}     </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(maxNum)"      >, #{maxNum}       </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(useFlag)"    >, #{useFlag}     </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(activeYn)"    >, #{activeYn}     </if>
         , 'Y'
         , #{gsUserId}
         , NOW()
         , #{gsUserId}
         , NOW()
    </sql>

    <sql id="updateColumns">
           CHNG_ID   = #{gsUserId}
         , CHNG_DATE = NOW()
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnYear)"   >, EXHBN_YEAR     = #{exhbnYear}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnName)"   >, EXHBN_NAME     = #{exhbnName}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnBgnDate)">, EXHBN_BGN_DATE = DATE_FORMAT(STR_TO_DATE(#{exhbnBgnDate}, '%m.%d.%Y'),'%Y-%m-%d') </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnEndDate)">, EXHBN_END_DATE = DATE_FORMAT(STR_TO_DATE(#{exhbnEndDate}, '%m.%d.%Y'),'%Y-%m-%d') </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnLoc)"    >, EXHBN_LOC      = #{exhbnLoc}     </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(maxNum)"      >, MAX_NUM        = #{maxNum}       </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(useFlag)"    >, COUPON_YN      = #{useFlag}     </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(activeYn)"    >, ACTIVE_YN      = #{activeYn}     </if>
    </sql>

    <sql id="whereClause">
    	SYS_ID = #{sysId}
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnCode)  ">AND EXHBN_CODE LIKE CONCAT('%',#{exhbnCode},'%') </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnYear)  ">AND EXHBN_YEAR = #{exhbnYear}  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnActive)">AND ACTIVE_YN  = #{exhbnActive}</if>
        AND USE_YN = 'Y'
    </sql>

    <sql id="whereClause-search">
    	SYS_ID = #{sysId}
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnCode)  ">AND EXHBN_CODE LIKE CONCAT('%',#{exhbnCode},'%') </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnYear)  ">AND EXHBN_YEAR = #{exhbnYear}  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnActive)">AND ACTIVE_YN  = #{exhbnActive}</if>
        AND USE_YN = 'Y'
    </sql>

    <select id="search" resultType="code" parameterType="params">
        <include refid="pagingOpen"  /><!-- PAGING -->
        SELECT <include refid="selectColumns" />
               <include refid="pagingColumns" /><!-- PAGING -->
          FROM EXHBN_MAST A
         WHERE <include refid="whereClause-search" />
         ORDER
            BY <include refid="sortClause" /><!-- SORT -->
        <include refid="pagingClose" /><!-- PAGING -->
    </select>
    <select id="searchCount" resultType="int" parameterType="params">
        SELECT COUNT(1)
          FROM EXHBN_MAST
         WHERE <include refid="whereClause-search" />
    </select>
    <select id="select" resultType="code" parameterType="params">
        SELECT <include refid="selectColumns" />
          FROM EXHBN_MAST
         WHERE SYS_ID    = #{sysId}
            <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnCode)  ">AND EXHBN_CODE = #{exhbnCode}  </if>
        	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnYear)  ">AND EXHBN_YEAR = #{exhbnYear}  </if>
        	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(exhbnActive)">AND ACTIVE_YN  = #{exhbnActive}</if>
           AND USE_YN = 'Y'
           ORDER BY SEQ
    </select>
    
    <insert id="insert" parameterType="params">
    	CALL sp_insert_exhbn(#{sysId}, #{gsUserId}, #{exhbnYear}, #{exhbnName}, #{exhbnBgnDate}, #{exhbnEndDate}, #{exhbnLoc}, #{maxNum}, #{useFlag}, #{activeYn}, #{seq}, #{exhbnCode})
    </insert>
    
    <update id="update" parameterType="params">
        CALL sp_update_exhbn(#{sysId}, #{gsUserId}, #{exhbnYear}, #{exhbnName}, #{exhbnBgnDate}, #{exhbnEndDate}, #{exhbnLoc}, #{maxNum}, #{useFlag}, #{activeYn}, #{seq}, #{exhbnCode})
    </update>
    
    <update id="delete" parameterType="params">
        UPDATE EXHBN_MAST
           SET USE_YN = 'N'
             , EXHBN_CODE = CONCAT('DEL-',#{exhbnCode})
             , CHNG_ID = #{gsUserId}
             , CHNG_DATE = NOW()
         WHERE SYS_ID     = #{sysId}
           AND EXHBN_CODE = #{exhbnCode}
           AND USE_YN = 'Y'
    </update>
    
    <select id="getSelectCodeExhbn" resultType="record" parameterType="params">
		SELECT CODE_CD as "codeCd"
		     , CODE_NAME as "codeName"
		  FROM SYS_CODE
		 WHERE CODE_GRUP ='0'
		    AND SYS_ID = #{sysId}
		    AND CODE_CD != '0'
		    AND USE_FLAG = 'Y'
		 ORDER BY SORT_SEQ
	</select>
	<select id="getSelectCodeSortExhbn" resultType="record" parameterType="params">
		SELECT CODE_CD as "codeCd"
		     , CODE_NAME as "codeName"
		  FROM SYS_CODE
		 WHERE CODE_GRUP ='CODE_SORT'
		 AND USE_FLAG = 'Y'
		 ORDER BY CODE_NAME ASC
	</select>

	<select id="searchCodeExhbn" resultType="record" parameterType="params">
		SELECT CODE_GRUP
		     , CODE_CD		     
		     , CASE WHEN #{gsLang} = 'ko' THEN CODE_NAME
		     		WHEN #{gsLang} = 'en' THEN CODE_NAME_EN
		     		WHEN #{gsLang} = 'vi' THEN CODE_NAME_VI
		     		ELSE CODE_NAME
		       END AS CODE_NAME		     		
		     , EXT_CHR01
		     , SORT_SEQ
		     , CODE_DESC
		  FROM SYS_CODE
		 WHERE SYS_ID = #{sysId}
		   AND CODE_GRUP IN(${codeGrup})
		   AND USE_FLAG = 'Y'
		   ORDER BY SORT_SEQ

	</select>
	
    <select id="exhibitionSearchImage" resultType="record" parameterType="params">
		CALL sp_select_exhbn_image(#{sysId}, #{gsUserId}, #{atchGrup}, #{atchNo}, #{atchSeq})
	</select>
    
    <select id="saveExhbnImage" resultType="hashmap" parameterType="params">
        CALL sp_save_exhbn_image(#{sysId}, #{gsUserId}, #{atchGrup}, #{atchNo}, #{atchSeq}, #{atchImg})
    </select>
    
    
</mapper>
