<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wsc.common.sample.Sampleboard">

 
    <!-- ========================================================== -->
    <!--   Oracle Paging Clause                                     -->
    <!-- ========================================================== -->
    <sql id="pagingColumns">
        <if test="start == null or end == null">
            ,0 AS "rnum"
        </if>
    </sql>
    <sql id="pagingOpen">
        <if test="start != null and end != null">
            SELECT * 
              FROM (
                    SELECT X.*
                      FROM (
                            SELECT Z1.*, @rownum := @rownum+1 as RNUM
                              FROM (
        </if>
    </sql>
    <sql id="pagingClose">
        <if test="start != null and end != null">
                                   ) Z1, (SELECT @rownum:=0 ) Z2
                           ) X
                     WHERE RNUM <![CDATA[< ]]> #{end}
                   ) X
             WHERE RNUM <![CDATA[>= ]]> #{start}
        </if>  
    </sql>
    <sql id="sortClause">
	  	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(gsSorts)">
		  	<foreach item="sort" collection="gsSorts" open="" separator="," close="">
		        ${sort}
		  	</foreach>
	  	</if>
	  	<if test="@com.wsc.framework.utils.MybatisUtils@empty(gsSorts)">
	  		   A.BORD_SEQ  ASC
	  		  ,A.REGI_DATE DESC
	  	</if>
    </sql>
    
    <sql id="selectColumns">
         SYS_ID        AS "sysId"
        ,BORD_NO       AS "bordNo"
        ,BORD_GRUP     AS "bordGrup"
        ,BORD_TITLE    AS "bordTitle"
        ,BORD_TYPE     AS "bordType"
        ,BORD_BGN      AS "bordBgn"
        ,BORD_END      AS "bordEnd"
        ,READ_CNT      AS "readCnt"
        ,BORD_SEQ      AS "bordSeq"
        ,BORD_PNO      AS "bordPno"
        ,OPEN_TYPE     AS "openType"
        ,USE_FLAG      AS "useFlag"
        ,REGI_ID       AS "regiId"
        ,REGI_DATE 	   AS "regiDate"
        ,CHNG_ID       AS "chngId"
        ,CHNG_DATE	   AS "chngDate"
		,A.REGI_ID     AS "regiName"
		,A.CHNG_ID     AS "chngName"
		,BORD_NO       AS "id"
		,BORD_PNO      AS "parentId"
		,CASE WHEN (SELECT COUNT(*)
		              FROM SYS_BORD
		             WHERE SYS_ID    = A.SYS_ID
		               AND BORD_PNO  = A.BORD_NO
		               AND BORD_GRUP = A.BORD_GRUP) = 0
		      THEN 'open'
		      ELSE 'closed'
		 END           AS "state"
		 ,(SELECT COUNT(Atch_No)
		    FROM SYS_FILE
		   WHERE SYS_ID    = A.SYS_ID
		     AND ATCH_NO   = A.BORD_NO
		     AND ATCH_GRUP = A.BORD_GRUP 
		)              AS "fileCnt"
    </sql>
    <sql id="insertColumns-fields">
           SYS_ID
         , BORD_NO
         , BORD_GRUP
         , BORD_TITLE
         , READ_CNT
         , BORD_SEQ
         , USE_FLAG
         , REGI_ID
         , REGI_DATE
         , CHNG_ID
         , CHNG_DATE
    </sql>
    <sql id="insertColumns-values">
           #{sysId}
         , #{bordNo}
         , #{bordGrup}
         , #{bordTitle}
         , 0
         , 999999999
         , 'Y'
         , #{gsUserId}
         , NOW()
         , #{gsUserId}
         , NOW()
    </sql>
    <sql id="updateColumns">
           CHNG_ID   = #{gsUserId}
         , CHNG_DATE = NOW()
         , BORD_TITLE = #{bordTitle}
    </sql>
    <sql id="whereClause">
    		SYS_ID    = #{sysId}
    	AND BORD_GRUP = 'B12'
    	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(useFlag  )">AND USE_FLAG   = #{useFlag}    </if>
    	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(regiId   )">AND REGI_ID    = #{regiId}     </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordTitle)">AND BORD_TITLE LIKE CONCAT('%', #{bordTitle},'%') </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordText )">AND BORD_TEXT  LIKE CONCAT('%', #{bordText},'%') </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordType )">AND BORD_TYPE  = #{bordType}   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordBgn  )">AND BORD_BGN   = #{bordBgn}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(bordEnd  )">AND BORD_END   = #{bordEnd}    </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(openType )">AND OPEN_TYPE  = #{openType}   </if>
        <!-- 검색조건,검색텍스트 입력시 -->
	    <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(searchText) and @com.wsc.framework.utils.MybatisUtils@notEmpty(searchKey)">
			<choose>
	    		<when test="searchKey == 'S01'"> 
	    			AND A.BORD_TITLE LIKE CONCAT('%', #{searchText},'%') 
	    		</when>
	    		<when test="searchKey == 'S02'"> 
	    			AND A.BORD_TEXT  LIKE CONCAT('%', #{searchText},'%')
	    		</when>
	    		<when test="searchKey == 'S03'"> 
	    			AND EXISTS (
	    			    SELECT 1
	    			      FROM SYS_USER
	    			     WHERE SYS_ID  = A.SYS_ID
	    			       AND USER_ID = A.REGI_ID
	    			       AND USER_NAME LIKE CONCAT('%', #{searchText},'%')
	    			    )
	    		</when>
	    		<otherwise>
	    		</otherwise>
			</choose>
	    </if>
    </sql>

    <select id="search" resultType="record" parameterType="params">
        <include refid="pagingOpen"  /><!-- PAGING -->
        SELECT <include refid="selectColumns" />
               <include refid="pagingColumns" /><!-- PAGING -->
          FROM SYS_BORD A
         WHERE <include refid="whereClause" />
         ORDER 
            BY <include refid="sortClause" /><!-- SORT -->
        <include refid="pagingClose" /><!-- PAGING -->
    </select>
    <select id="searchCount" resultType="int" parameterType="params">
        SELECT COUNT(1) 
          FROM SYS_BORD A
         WHERE <include refid="whereClause" />
    </select>
    <select id="select" resultType="record" parameterType="params">
        SELECT <include refid="selectColumns" />
          FROM SYS_BORD A
         WHERE SYS_ID    = #{sysId}
           AND BORD_NO   = #{bordNo}
           AND BORD_GRUP = #{bordGrup}
    </select>
    <insert id="insert" parameterType="params">
        <selectKey resultType="string" keyProperty="bordNo" order="BEFORE">
            SELECT CONCAT('B', LPAD(CAST(ifnull(SUBSTR(MAX(BORD_NO),2,9),'0') AS UNSIGNED)+1, 9, '0') )
                AS "bordNo"
              FROM SYS_BORD
             WHERE SYS_ID    = #{sysId}
               AND BORD_GRUP = #{bordGrup}
        </selectKey>
        INSERT 
          INTO SYS_BORD 
             ( <include refid="insertColumns-fields" /> )
        VALUES
             ( <include refid="insertColumns-values" /> )
    </insert>
    <update id="update" parameterType="params">
        UPDATE SYS_BORD
           SET <include refid="updateColumns" />
         WHERE SYS_ID    = #{sysId}
           AND BORD_NO   = #{bordNo}
           AND BORD_GRUP = #{bordGrup}
    </update>
    <delete id="delete" parameterType="params">
        DELETE 
          FROM SYS_BORD
         WHERE SYS_ID    = #{sysId}
           AND BORD_NO   = #{bordNo}
           AND BORD_GRUP = #{bordGrup}
    </delete>
    
    <select id="getListReorder" resultType="record" parameterType="params">
        CALL sp_sampleboard_list_reorder(#{sysId},#{gsUserId},#{WIND_ID}, #{VIEW_ID})
    </select>
    
    <select id="getListReorderDefault" resultType="record" parameterType="params">
        CALL sp_sampleboard_list_reorder_default(#{sysId},#{gsUserId},#{WIND_ID})
    </select>
    
    <select id="getListReorderList" resultType="record" parameterType="params">
        CALL sp_sampleboard_list_reorder_list(#{sysId},#{gsUserId},#{WIND_ID})
    </select>
    
    <!-- 엑셀 업로드 검증 -->
    <select id="excelUpload" resultType="record" parameterType="params" statementType="CALLABLE">
        CALL sp_sampleboard_excel_upload(#{sysId}, #{bordTitle}, #{readCnt}, #{regiName}, #{regiDate}, #{chngName}, #{chngDate}, #{gsUserId}, #{v_MSG})
    </select>
    
    <!-- 엑셀 업로드 저장 -->
    <select id="excelUpdate" resultType="record" parameterType="params" statementType="CALLABLE">
        CALL sp_sampleboard_excel_update(#{sysId}, #{bordNo}, #{bordTitle}, #{readCnt}, #{regiName}, #{regiDate}, #{chngName}, #{chngDate}, #{gsUserId}, #{bordGrup})
    </select>

</mapper>

