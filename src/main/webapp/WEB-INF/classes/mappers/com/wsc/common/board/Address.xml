<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wsc.common.board.Address">

    <!-- ========================================================== -->
    <!--   Oracle Paging Clause                                     -->
    <!-- ========================================================== -->
    <sql id="pagingColumns">
        <if test="start == null or end == null">
            ,0 AS "rnum"
        </if>
    </sql>
    <sql id="pagingOpen">
        <if test="start != null and end != null">
            SELECT * 
              FROM (
                    SELECT X.*
                      FROM (
                            SELECT Z1.*, @rownum := @rownum+1 as RNUM
                              FROM (
        </if>
    </sql>
    <sql id="pagingClose">
        <if test="start != null and end != null">
                                   ) Z1, (SELECT @rownum:=0 ) Z2
                           ) X
                     WHERE RNUM <![CDATA[< ]]> #{end}
                   ) X
             WHERE RNUM <![CDATA[>= ]]> #{start}
        </if>  
    </sql>
    <sql id="sortClause">
	  	<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(gsSorts)">
		  	<foreach item="sort" collection="gsSorts" open="" separator="," close="">
		        ${sort}
		  	</foreach>
	  	</if>
	  	<if test="@com.wsc.framework.utils.MybatisUtils@empty(gsSorts)">
         	   A.REGI_DATE DESC
         	  ,A.CHNG_DATE DESC
	  	</if>
    </sql>
    
    <sql id="selectColumns">
         SYS_ID        AS "sysId"
        ,BORD_GRUP     AS "bordGrup"
        ,USER_ID       AS "userId"
        ,REGI_ID       AS "regiId"
        ,DATE_FORMAT(REGI_DATE,'%Y-%m-%d %H:%i:%s')     
                       AS "regiDate"
        ,CHNG_ID       AS "chngId"
        ,DATE_FORMAT(CHNG_DATE,'%Y-%m-%d %H:%i:%s')     
                       AS "chngDate"
        ,TGT_USER_ID   AS "tgtUserId"
        ,TGT_USER_NAME AS "tgtUserName"
        ,TGT_USER_RMK  AS "tgtUserRmk"
        ,TGT_VNDR_CODE AS "tgtVndrCode"
        ,TGT_VNDR_NAME AS "tgtVndrName"
    </sql>
    <sql id="insertColumns-fields">
           SYS_ID
         , BORD_GRUP
         , USER_ID
         , REGI_ID
         , REGI_DATE
         , CHNG_ID
         , CHNG_DATE
         , TGT_USER_ID
         , TGT_USER_NAME
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserRmk )">, TGT_USER_RMK  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrCode)">, TGT_VNDR_CODE </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrName)">, TGT_VNDR_NAME </if>
    </sql>
    <sql id="insertColumns-values">
           #{sysId}
         , #{bordGrup}
         , #{userId}
         , #{gsUserId}
         , NOW()
         , #{gsUserId}
         , NOW()
         , #{tgtUserId}
         , #{tgtUserName}
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserRmk )">, #{tgtUserRmk}  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrCode)">, #{tgtVndrCode} </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrName)">, #{tgtVndrName} </if>
    </sql>
    <sql id="updateColumns">
           CHNG_ID   = #{gsUserId}
         , CHNG_DATE = NOW()
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserName)">, TGT_USER_NAME = #{tgtUserName} </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserRmk )">, TGT_USER_RMK  = #{tgtUserRmk}  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrCode)">, TGT_VNDR_CODE = #{tgtVndrCode} </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrName)">, TGT_VNDR_NAME = #{tgtVndrName} </if>
    </sql>
    <sql id="whereClause">
            SYS_ID    = #{sysId}
        AND BORD_GRUP = #{bordGrup}
        AND USER_ID   = #{userId} 
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserId  )">AND TGT_USER_ID   = #{tgtUserId}   </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserName)">AND TGT_USER_NAME = #{tgtUserName} </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserRmk )">AND TGT_USER_RMK  = #{tgtUserRmk}  </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrCode)">AND TGT_VNDR_CODE = #{tgtVndrCode} </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrName)">AND TGT_VNDR_NAME = #{tgtVndrName} </if>
    </sql>

    <select id="search" resultType="record" parameterType="params">
        <include refid="pagingOpen"  /><!-- PAGING -->
        SELECT <include refid="selectColumns" />
               <include refid="pagingColumns" /><!-- PAGING -->
          FROM SYS_BORD_ADDR A
         WHERE <include refid="whereClause" />
         ORDER 
            BY <include refid="sortClause" /><!-- SORT -->
        <include refid="pagingClose" /><!-- PAGING -->
    </select>
    <select id="searchCount" resultType="int" parameterType="params">
        SELECT COUNT(1) 
          FROM SYS_BORD_ADDR A
         WHERE <include refid="whereClause" />
    </select>
    <select id="select" resultType="record" parameterType="params">
        SELECT <include refid="selectColumns" />
          FROM SYS_BORD_ADDR A
         WHERE SYS_ID      = #{sysId}
           AND BORD_GRUP   = #{bordGrup}
           AND USER_ID     = #{userId}
           AND TGT_USER_ID = #{tgtUserId}
    </select>
    <insert id="insert" parameterType="params">
        INSERT 
          INTO SYS_BORD_ADDR 
             ( <include refid="insertColumns-fields" /> )
        VALUES
             ( <include refid="insertColumns-values" /> )
    </insert>
    <update id="update" parameterType="params">
        UPDATE SYS_BORD_ADDR
           SET <include refid="updateColumns" />
         WHERE SYS_ID      = #{sysId}
           AND BORD_GRUP   = #{bordGrup}
           AND USER_ID     = #{userId}
           AND TGT_USER_ID = #{tgtUserId}
    </update>
    <delete id="delete" parameterType="params">
        DELETE 
          FROM SYS_BORD_ADDR
         WHERE SYS_ID      = #{sysId}
           AND BORD_GRUP   = #{bordGrup}
           AND USER_ID     = #{userId}
           AND TGT_USER_ID = #{tgtUserId}
    </delete>
    
    <!-- ========================================================== -->
    <!--   Board Address Group Management                           -->
    <!-- ========================================================== -->
    <sql id="selectColumns-group">
         SYS_ID        AS "sysId"
        ,BORD_GRUP     AS "bordGrup"
        ,USER_ID       AS "userId"
        ,REGI_ID       AS "regiId"
        ,DATE_FORMAT(REGI_DATE,'%Y-%m-%d %H:%i:%s')     
                       AS "regiDate"
        ,CHNG_ID       AS "chngId"
        ,DATE_FORMAT(CHNG_DATE,'%Y-%m-%d %H:%i:%s')     
                       AS "chngDate"
        ,TGT_GRUP_ID   AS "tgtGrupId"
        ,TGT_GRUP_NAME AS "tgtGrupName"
        ,TGT_GRUP_RMK  AS "tgtGrupRmk"
    </sql>
    <sql id="whereClause-group">
            SYS_ID        = #{sysId}
        AND BORD_GRUP     = #{bordGrup}
        AND USER_ID       = #{userId}
		<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtGrupId  )">
        AND TGT_GRUP_ID   = #{tgtGrupId}   
        </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtGrupName)">
        AND TGT_GRUP_NAME = #{tgtGrupName} 
        </if>
    </sql>

    <select id="searchGroup" resultType="record" parameterType="params">
        <include refid="pagingOpen"  /><!-- PAGING -->
        SELECT <include refid="selectColumns-group" />
               <include refid="pagingColumns" /><!-- PAGING -->
          FROM SYS_BORD_GRUP A
         WHERE <include refid="whereClause-group" />
         ORDER 
            BY <include refid="sortClause" /><!-- SORT -->
        <include refid="pagingClose" /><!-- PAGING -->
    </select>
    <select id="searchGroupCount" resultType="int" parameterType="params">
        SELECT COUNT(1) 
          FROM SYS_BORD_GRUP A
         WHERE <include refid="whereClause-group" />
    </select>
    <select id="selectGroup" resultType="record" parameterType="params">
        SELECT <include refid="selectColumns-group" />
          FROM SYS_BORD_GRUP A
         WHERE SYS_ID      = #{sysId}
           AND TGT_GRUP_ID = #{tgtGrupId}
    </select>
    <insert id="insertGroup" parameterType="params">
        <selectKey resultType="string" keyProperty="tgtGrupId" order="BEFORE">
            SELECT CONCAT('G', LPAD(CAST(ifnull(SUBSTR(MAX(TGT_GRUP_ID),2,9),'0') AS UNSIGNED)+1, 9, '0') )
                AS "tgtGrupId"
              FROM SYS_BORD_GRUP
        </selectKey>
        INSERT 
          INTO SYS_BORD_GRUP 
             ( SYS_ID
	         , BORD_GRUP
	         , USER_ID
	         , REGI_ID
	         , REGI_DATE
	         , CHNG_ID
	         , CHNG_DATE
	         , TGT_GRUP_ID
	         , TGT_GRUP_NAME
	    <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtGrupRmk )">
	         , TGT_GRUP_RMK  
	    </if>
             )
        VALUES
             ( #{sysId}
	         , #{bordGrup}
	         , #{userId}
	         , #{gsUserId}
	         , NOW()
	         , #{gsUserId}
	         , NOW()
	         , #{tgtGrupId}
	         , #{tgtGrupName}
		<if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtGrupRmk )">
	         , #{tgtGrupRmk}  
	    </if>
             )
    </insert>
    <update id="updateGroup" parameterType="params">
        UPDATE SYS_BORD_GRUP
           SET CHNG_ID       = #{gsUserId}
	         , CHNG_DATE     = NOW()
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtGrupName)">
	         , TGT_GRUP_NAME = #{tgtGrupName} 
        </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtGrupRmk )">
	         , TGT_GRUP_RMK  = #{tgtGrupRmk}  
        </if>
         WHERE SYS_ID      = #{sysId}
           AND TGT_GRUP_ID = #{tgtGrupId}
    </update>
    <delete id="deleteGroup" parameterType="params">
        DELETE 
          FROM SYS_BORD_GRUP
         WHERE SYS_ID      = #{sysId}
           AND TGT_GRUP_ID = #{tgtGrupId}
    </delete>


    <!-- ========================================================== -->
    <!--   Board Address Group Item Management                      -->
    <!-- ========================================================== -->
    <sql id="selectColumns-item">
         SYS_ID        AS "sysId"
        ,REGI_ID       AS "regiId"
        ,DATE_FORMAT(REGI_DATE,'%Y-%m-%d %H:%i:%s')     
                       AS "regiDate"
        ,CHNG_ID       AS "chngId"
        ,DATE_FORMAT(CHNG_DATE,'%Y-%m-%d %H:%i:%s')     
                       AS "chngDate"
        ,TGT_GRUP_ID   AS "tgtGrupId"
        ,TGT_USER_ID   AS "tgtUserId"
        ,TGT_USER_NAME AS "tgtUserName"
        ,TGT_VNDR_CODE AS "tgtVndrCode"
        ,TGT_VNDR_NAME AS "tgtVndrName"
    </sql>

    <select id="searchGroupItem" resultType="record" parameterType="params">
        <include refid="pagingOpen"  /><!-- PAGING -->
        SELECT <include refid="selectColumns-item" />
               <include refid="pagingColumns" /><!-- PAGING -->
          FROM SYS_BORD_ITEM A
         WHERE SYS_ID      = #{sysId}
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtGrupId)">
           AND TGT_GRUP_ID = #{tgtGrupId} 
        </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserId)">
           AND TGT_USER_ID = #{tgtUserId} 
        </if>
         ORDER 
            BY <include refid="sortClause" /><!-- SORT -->
        <include refid="pagingClose" /><!-- PAGING -->
    </select>
    <select id="searchGroupItemCount" resultType="int" parameterType="params">
        SELECT COUNT(1) 
          FROM SYS_BORD_ITEM A
         WHERE SYS_ID      = #{sysId}
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtGrupId)">
           AND TGT_GRUP_ID = #{tgtGrupId} 
        </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserId)">
           AND TGT_USER_ID = #{tgtUserId} 
        </if>
    </select>
    <select id="selectGroupItem" resultType="record" parameterType="params">
        SELECT <include refid="selectColumns-item" />
          FROM SYS_BORD_ITEM A
         WHERE SYS_ID      = #{sysId}
           AND TGT_GRUP_ID = #{tgtGrupId}
           AND TGT_USER_ID = #{tgtUserId}
    </select>
    <insert id="insertGroupItem" parameterType="params">
        INSERT 
          INTO SYS_BORD_ITEM 
             ( SYS_ID
	         , TGT_GRUP_ID
	         , TGT_USER_ID
	         , TGT_USER_NAME
	        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrCode)">, TGT_VNDR_CODE </if>
	        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrName)">, TGT_VNDR_NAME </if>
	         , REGI_ID
	         , REGI_DATE
	         , CHNG_ID
	         , CHNG_DATE
             )
        VALUES
             ( #{sysId}
	         , #{tgtGrupId}
	         , #{tgtUserId}
	         , #{tgtUserName}
	        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrCode)">, #{tgtVndrCode} </if>
	        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrName)">, #{tgtVndrName} </if>
	         , #{gsUserId}
	         , NOW()
	         , #{gsUserId}
	         , NOW()
             )
    </insert>
    <update id="updateGroupItem" parameterType="params">
        UPDATE SYS_BORD_ITEM
           SET CHNG_ID       = #{gsUserId}
	         , CHNG_DATE     = NOW()
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtUserName)">
	         , TGT_USER_NAME = #{tgtUserName} 
        </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrCode)">
	         , TGT_VNDR_CODE = #{tgtVndrCode} 
        </if>
        <if test="@com.wsc.framework.utils.MybatisUtils@notEmpty(tgtVndrName)">
	         , TGT_VNDR_NAME = #{tgtVndrName} 
        </if>
         WHERE SYS_ID      = #{sysId}
           AND TGT_GRUP_ID = #{tgtGrupId}
           AND TGT_USER_ID = #{tgtUserId}
    </update>
    <delete id="deleteGroupItemAll" parameterType="params">
        DELETE 
          FROM SYS_BORD_ITEM
         WHERE SYS_ID      = #{sysId}
           AND TGT_GRUP_ID = #{tgtGrupId}
    </delete>

</mapper>
