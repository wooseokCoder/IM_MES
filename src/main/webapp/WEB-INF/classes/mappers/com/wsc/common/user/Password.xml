<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wsc.common.user.Password">

    <update id="updateUserPw" parameterType="params">
        UPDATE SYS_USER
           SET USER_PWD = HEX( AES_ENCRYPT( #{userId},#{newPw}))
              ,PWD_CHNG_DATE = NOW()
              ,USE_FLAG = 'Y'
              ,LOGIN_FAIL_CNT = 0
         WHERE SYS_ID   = #{sysId}
           AND USER_ID  = #{userId}
    </update>
    <select id="chkUserPw" parameterType="params" resultType="record">
    	SELECT USER_ID
    	  FROM SYS_USER
    	 WHERE SYS_ID   = #{sysId}
    	   AND USER_ID  = #{gsUserId}
    	   AND USER_PWD =  HEX( AES_ENCRYPT( #{gsUserId},#{oldPw}))
    </select>
    <select id="chkUserPw2" parameterType="params" resultType="record">
    	SELECT USER_ID
    	  FROM SYS_USER
    	 WHERE SYS_ID   = #{sysId}
    	   AND USER_ID  = #{gsUserId}
    	   AND (USER_PWD =  HEX( AES_ENCRYPT( #{gsUserId},#{oldPw}))
    	       OR fn_chk_user_pwd(#{oldPw}) = 'Y')
    </select>
    <update id="updateUserPw-user" parameterType="params">
        UPDATE SYS_USER
           SET USER_PWD = HEX( AES_ENCRYPT( #{gsUserId},#{newPw}))
              ,PWD_CHNG_DATE = NOW()
         WHERE SYS_ID   = #{sysId}
           AND USER_ID  = #{gsUserId}
    </update>
    
    <select id="emailCheck" parameterType="params" resultType="record">
    	SELECT CONCAT( LPAD(CONV(FLOOR(RAND()*POW(36,8)), 10, 36), 5, 0), LPAD(CONV(FLOOR(RAND()*POW(36,8)), 10, 36), 5, 0)) AS "newPw"
    	  FROM SYS_USER
    	 WHERE SYS_ID   = #{sysId}
    	   AND USER_ID  = #{userId}
    	   AND USER_MAIL = #{email}
    </select>
    
    <select id="chkUserChar" parameterType="params" resultType="record">
     	SELECT USER_ID,USE_FLAG AS LockYn,
     	       IFNULL(OLD_USER_ID, '') AS oldUserId,
     	       USER_TYPE AS userType,
     	       ORG_AUTH_CODE AS orgAuthCode
    	  FROM SYS_USER
    	 WHERE SYS_ID   = #{sysId}
    	   AND (LOWER(USER_ID)  = TRIM(LOWER(#{userId}))
    	   OR  LOWER(OLD_USER_ID)  = TRIM(LOWER(#{userId})))

    </select>
    <!-- 로그인 실패시 실패카운트 증가 -->
    <update id="updateLoginNG" parameterType="params">
        UPDATE SYS_USER
           SET LOGIN_FAIL_CNT = LOGIN_FAIL_CNT + 1
              ,LAST_LOGIN_DATE = DATE_FORMAT( Now(),'%Y-%m-%d %H:%i:%s')
              ,USE_FLAG = CASE WHEN LOGIN_FAIL_CNT * 1 >= fn_get_code_desc( 'SYS_VAR', 'LOGIN_FAIL_CNT') * 1 THEN 'N' ELSE USE_FLAG END
         WHERE SYS_ID         = #{sysId}
           AND USER_ID        = #{gsUserId}
    </update>

    <!-- 로그인 성공시 실패카운트 리셋 및 최종로그인일시 업데이트 -->
    <update id="updateLoginOK" parameterType="params">
        UPDATE SYS_USER
           SET LOGIN_FAIL_CNT  = 0
              ,LAST_LOGIN_DATE = DATE_FORMAT( Now(),'%Y-%m-%d %H:%i:%s')
         WHERE SYS_ID          = #{sysId}
           AND USER_ID         = #{gsUserId}
    </update>
    <select id="checkLoginSts"  parameterType="params"  resultType="record">
        SELECT USE_FLAG  AS LockYn
    	  FROM SYS_USER
         WHERE SYS_ID = #{sysId}
           AND USER_ID = #{gsUserId}
    </select>
    
    <update id="RejectCheck" parameterType="params">
    	CALL sp_update_gate_pass_reject(#{sysId}, #{bolNo}, #{Reason})
    </update>
</mapper>
